<!DOCTYPE html>
<html>
<head>
  <title>Per User SSE Demo</title>
  <style>
    body {font-family:Arial, Helvetica, sans-serif;
          text-align:center;}
    div, input {font-size: 1.5em;}
    textarea {font-size:1.2em;}
    button {font-size:1.2rem; border-radius:0.5em;background-color:lightgray;
            margin:0 0.5rem;}
  </style>
</head>
<body>
  <h1>Push the button, Max!!</h1>
  <input placeholder="Enter name" id="name" type="text" aria-label="Name"/>
  <br/><br/>
  <div><button id="pushme">Submit!</button><button id="disconnect">Stop listening</button></div>
  <hr/>
  <div>Message: <span id="message">Push the button...</span></div>
  <div>State: <span id="state">(waiting)</span></div>
  <hr/>
  <h2>Registrants:</h2>
  <textarea readonly rows="8" id="registrants"></textarea>
  <br/>
  <button id="clear-registrants">Clear Registrants</button> 
</body>
<script src="./jquery-2.1.4.min.js"></script>
<script src="./axios.min.js"></script>
<script>
  let SSESource = null;
  let myID;
  const APPURL = 'http://localhost:3000';

  $("#pushme").on('click', function(evt) {
    let name = $('#name').val();
    if (name.length === 0) {
      alert("Need a name to start...");
      return;
    }
    console.log('Started for: ' + name);
    if (!SSESource) {
      axios.get(APPURL + '/make-id/' + name)
      .then(function(rsp) {
        myID = rsp.data;
        console.log(' --> set myID: ' + myID);
        registerServerListener(myID);
        doSubmit();
      })
      .catch(function(err){
        console.log('Error registering: ' + err);
      });
    } else {
      doSubmit();
    }
  });

  $("#disconnect").on('click', function(evt) {
    if (SSESource === null)
      return; 

    console.log('in disconnect, closing SSESource');
    SSESource.close();
    SSESourceClosed();      // no event on close --
                            // force response
  });

  $("#clear-registrants").on('click', function(evt){
    axios.get(APPURL + '/clear-registrants')
    .then(function(rsp){
      fetchRegisteredListeners();
    })
    .catch(function(err){
      console.log('Error in clear-registrants: ' + err);
    });
  });

  function doSubmit(){
    axios.get(APPURL + "/submitted/" + myID)
    .then(function(rsp) {
      $("#message").text("Submitted for: " + myID + " -- waiting!");
    })
    .catch(function(err) {
      if (err.response.status === 404) {
        console.log(' --> not registered -- reregistering and try again')
        registerServerListener(myID);
        setTimeout(doSubmit, 100);
        return;
      }
      
      console.log('submit error: ' + err);
    });
  }

  function SSESourceClosed() {
    $("#state").text("Disconnected"); 
    axios.get(APPURL + '/disconnect-registrant/' + myID)
    .then(function(rsp){
      $("#message").text(rsp.data);
      SSESource = null;
      myID = null;
    })
    .then(function(rsp){
      fetchRegisteredListeners();
    })
    .catch(function(err) {
      console.log('disconnect error: ' + err);
    }); 
  };

  function getNotificationData(data) {
    return data.split(':')[1];
  }

  function fetchRegisteredListeners() {
    axios.get(APPURL + '/list-registrants')
    .then(function(rsp){
      setRegisteredListeners(rsp.data);
    })
    .catch(function(err) {
      console.log('Error fetching registered users on load: ' + err);
    });
  }

  function setRegisteredListeners(data) {
    let listeners = data.replace(/\+/g, '\n');
    $("#registrants").val(listeners);
  }

  function registerServerListener(id) {
    if (!!window.EventSource) {
      SSESource = new EventSource(APPURL + '/register-listener/' + id);
      SSESource.addEventListener('message', function(evt) {
        let data = evt.data.slice(1, -1);
                  // get rid of quotes...

        if (data === "listeners-changed") {
          fetchRegisteredListeners();
          return;
        }
        $("#message").text(data);
        setTimeout(function(){
          $("#message").text("Push it again...");
        },10000);
      });

      SSESource.addEventListener('open', function(evt) {
        $("#state").text("Connected");
        fetchRegisteredListeners();
      });

      SSESource.addEventListener('error', function(evt){
        if (evt.target.readyState === EventSource.CLOSED) {
          SSESourceClosed(); 
        } else if (evt.target.readyState === EventSource.CONNECTING) {
          $("#state").text("Connecting...");
        }
      });
    } else {
      console.log("Your browser doesn't support SSE")
    }
  }

  fetchRegisteredListeners();
</script>
</html>

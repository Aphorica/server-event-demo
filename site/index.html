<!DOCTYPE html>
<html>
<head>
  <title>Per User SSE Demo</title>
  <style>
    body {font-family:Arial, Helvetica, sans-serif;
          text-align:center;}
    div, input {font-size: 1.5em;}
    table {font-size:1.2rem;border-collapse:collapse;}
    #message-table, #table-ctnr {width: 90%; margin:0 auto;
                                 border:thin solid darkgray}
    #table-ctnr {height:12rem;overflow-y:scroll;}
    #table-ctnr table {width:100%;}
    #table-ctnr table tr:nth-child(even) {background-color:#eee}
    td {padding-top:0.3em; padding-bottom:0.3em;}
    th {text-align:right;}
    td {text-align:left;padding-left:1rem;}
    button {font-size:1.2rem; border-radius:0.5em;background-color:lightgray;
            margin:0 0.5rem;}
  </style>
</head>
<body>
  <h1>Push the button, Max!!</h1>
  <input placeholder="Enter name" id="name" type="text" aria-label="Name"/>
  <br/><br/>
  <div><button id="submit">Submit!</button><button id="disconnect">Stop listening</button></div>
  <br/>
  <table id="message-table">
    <tr><th>Message:</th><td id="message">Push the button...</td></tr>
    <tr><th>Response:</th><td id="response">(none)</td></tr>
    <tr><th>State:</th><td id="state">(waiting)</td></tr>
  </table>
  <h2>Registrants:</h2>
  <div id="table-ctnr">
  <table id="registrants"></table>
  </div>
  <br/>
  <button id="clear-registrants">Clear Registrants</button>
  <button id="trigger-cleanup">Trigger Cleanup</button><br/><br/>
  <button id="trigger-server-response">Trigger Server Response</button><br/><br/>
</body>
<script src="./jquery-2.1.4.min.js"></script>
<script src="./axios.min.js"></script>
<script>
  let SSESource = null;
  let myID;
  const APPURL = 'http://nebula.local:3000';

  $("#submit").on('click', function(evt) {
    let name = $('#name').val();
    if (name.length === 0) {
      alert("Need a name to start...");
      return;
    }
    console.log('Started for: ' + name);
    if (!SSESource) {
      axios.get(APPURL + '/make-id/' + name)
      .then(function(rsp) {
        myID = rsp.data;
        console.log(' --> set myID: ' + myID);
        registerServerListener(myID);
        doSubmit();
      })
      .catch(function(err){
        console.log('Error registering: ' + err);
      });
    } else {
      doSubmit();
    }
  });

  $("#disconnect").on('click', function(evt) {
    if (SSESource === null)
      return; 

    console.log('in disconnect, closing SSESource');
    SSESource.close();
    axios.get(APPURL + '/disconnect-registrant/' + myID)
    .then(function(rsp){
      $('#message').text('Item removed');
     SSESourceClosed();
    })
    .catch(function(err){
      console.log('Error disconnecting');
    });
  });

  $("#clear-registrants").on('click', function(evt){
    axios.get(APPURL + '/clear-registrants')
    .then(function(rsp){
      fetchRegisteredListeners();
    })
    .catch(function(err){
      console.log('Error in clear-registrants: ' + err);
    });
  });

  $("#trigger-cleanup").on('click', function(evt){
    axios.get(APPURL + '/trigger-cleanup')
    .then(function(){
      console.log('Cleanup ok');
      fetchRegisteredListeners();
    })
    .catch(function(err){
      console.log('Error in cleanup: ' + err);
    })
  });

  $("#trigger-server-response").on('click', function(evt){
    axios.get(APPURL + '/trigger-server-response/' + myID)
    .then(function(){
      console.log('Triggered Server Reponse ok');
      setTimeout(fetchRegisteredListeners, 0);
    })
    .catch(function(err){
      console.log('Error in trigger-server-response: ' + err);
    })
  });

  function makeTimeString(timeStamp) {
    return new Date(timeStamp).toTimeString().substr(0, 8);
  }

  function doSubmit(){
    console.log('in doSubmit: ' + myID);
    axios.put(APPURL + ["/submit-task", myID, "timeout-test"].join('/'))
    .then(function(rsp) {
      $("#message").text("Submitted for: " + myID);
      $("#response").text("(none)");
    })
    .catch(function(err) {
      if (err.response.status === 404) {
        console.log(' --> not registered -- reregistering and try again')
        registerServerListener(myID);
        setTimeout(doSubmit, 100);
        return;
      }
      
      console.log('submit error: ' + err);
    });
  }

  function setSSEStateText() {
    if (SSESource !== null) {
      let stateText =
        SSESource.readyState === SSESource.CLOSED? "Disconnected" :
        SSESource.readyState === SSESource.CONNECTING? "Connecting":
        "Connected";

        $("#state").text(stateText);
    }
  }

  function SSESourceClosed() {
    if (SSESource !== null) {
      setSSEStateText();
      fetchRegisteredListeners();
      if (SSESource.readyState === SSESource.CLOSED)
        SSESource = null;
                // cleanup
    }
  };

  function getNotificationData(_data) {
    let data = _data.charAt(0) === '"'? _data.slice(1,-1) : _data;
              // dequote if quoted
    let retData;
    
    if (data.indexOf('^') !== -1) {
      let dataAry = data.split('^');

      retData = {
        response: dataAry[0],
        info: dataAry[1].charAt(0) === '{'?
              JSON.parse(dataAry[1].replace(/\\/g, '')) : dataAry[1]
      };
    }
    else
      retData = {response: data, info: null};

    return retData;
  }

  function fetchRegisteredListeners() {
    axios.get(APPURL + '/list-registrants')
    .then(function(rsp){
      renderRegisteredListeners(rsp.data);
    })
    .catch(function(err) {
      console.log('Error fetching registered users on load: ' + err);
    });
  }

  function renderRegisteredListeners(data) {
    let tableContents = '<tbody>\n';
    let idKeys = Object.keys(data), idKey, startTime;
    for (let ix = 0; ix < idKeys.length; ++ix) 
    {
      idKey = idKeys[ix];
      tableContents +=
            '<tr><td>' + 
            idKey + 
            '</td><td>' + 
            makeTimeString(data[idKey]['registered-ts']) +
            '</td></tr>\n';      
    }
    tableContents += '</tbody>';
    $("#registrants").html(tableContents);
  }

  function registerServerListener(id) {
    return new Promise(function(acc,rej) {
      if (!!window.EventSource) {
        SSESource = new EventSource(APPURL + '/register-listener/' + id);
        SSESource.addEventListener('message', function(evt) {
          let data = getNotificationData(evt.data);

          switch(data.response) {
            case "listeners-changed":
              fetchRegisteredListeners();
              return;

            case "completed":
              if (data.info.id !== myID)
                $("#message").text('Got reponse for someone else: ' + id +
                                   ', taskid: ' + data.info.taskid);

              $("#response").text('Task completed: ' + data.info.taskid);
              break;

            case "registered":
              $("#message").text("Registered: " + data.info);
              fetchRegisteredListeners();
              break;

            default:
              $("#message").text("Unrecognized: " + data.response);
          }
        });

        SSESource.addEventListener('open', function(evt) {
          setSSEStateText();
          fetchRegisteredListeners();
        });

        SSESource.addEventListener('error', function(evt){
          if (evt.target.readyState === EventSource.CLOSED) {
            SSESourceClosed(); 
          } else if (evt.target.readyState === EventSource.CONNECTING) {
            setSSEStateText();
          }
        });

        acc(true);

      } else {
        console.log("Your browser doesn't support SSE")
        rej(false);
      }
    });
  }

  fetchRegisteredListeners();
</script>
</html>
